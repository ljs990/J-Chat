<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>J-Chat ðŸ”’</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

<style>
*{font-family:'Noto Sans KR',sans-serif}
body{
  background:#b2c7da;
  overscroll-behavior:none;
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
}
.chat{height:100vh;display:flex;flex-direction:column}
.chat-bubble{background:white;border-radius:18px;padding:8px 12px;max-width:70%}
.me{background:#ffe812;margin-left:auto}
</style>
</head>

<body>

<div class="chat max-w-[420px] mx-auto bg-white shadow-2xl">

  <div class="p-3 bg-[#a9bdce]">
    <div class="font-bold">J-Chat ðŸ”’</div>
    <div id="roomInfo" class="text-xs"></div>
  </div>

  <div id="users" class="flex gap-2 p-2 bg-[#a9bdce] overflow-x-auto"></div>

  <div id="chat" class="flex-1 overflow-y-auto p-3 bg-[#b2c7da] space-y-2"></div>

  <div class="p-2 bg-[#a9bdce] flex gap-2">
    <input type="file" id="fileInput" hidden accept="image/*">
    <button onclick="fileInput.click()" class="px-3 bg-white rounded-full">ðŸ“Ž</button>
    <input id="msg" class="flex-1 h-[44px] px-4 rounded-full" placeholder="ë©”ì‹œì§€">
    <button onclick="send()" class="px-4 bg-[#ffe812] rounded-full">ì „ì†¡</button>
  </div>

</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyD3zF8IzJiHvbH4UrkEHEUe588um-VaUJs",
  databaseURL: "https://j-chat-97bbe-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ================= Room ================= */
const room = location.hash.slice(1) || Math.random().toString(36).slice(2,10);
location.hash = room;

const nickname = prompt("ë‹‰ë„¤ìž„ ìž…ë ¥") || "ìµëª…";
const roomRef = db.ref("rooms/"+room);
let isOwner=false;

/* ================= Enter ================= */
roomRef.once("value", s=>{
  if(!s.exists()){
    roomRef.set({ owner:nickname });
    isOwner=true;
  }else{
    isOwner = s.val().owner === nickname;
  }
  roomRef.child("users/"+nickname).set(true);
  roomInfo.textContent = `ë°© ì½”ë“œ: ${room} ${isOwner?'ðŸ‘‘ë°©ìž¥':''}`;
});

/* ================= User List ================= */
roomRef.child("users").on("value", s=>{
  users.innerHTML="";
  s.forEach(u=>{
    const d=document.createElement("div");
    d.className="bg-white px-3 py-1 rounded-full text-sm flex items-center gap-1";
    d.textContent=u.key;
    if(isOwner && u.key!==nickname){
      const b=document.createElement("button");
      b.textContent="âŒ";
      b.onclick=()=>kick(u.key);
      d.appendChild(b);
    }
    users.appendChild(d);
  });
});

/* ================= Kick ================= */
function kick(user){
  if(!isOwner) return;
  if(confirm(user+" ê°•í‡´?")){
    roomRef.child("users/"+user).remove();
    roomRef.child("system").push({text:`${user} ê°•í‡´ë¨`});
  }
}

/* ================= Chat ================= */
function send(){
  if(!msg.value) return;
  roomRef.child("chat").push({n:nickname,t:msg.value});
  msg.value="";
}

roomRef.child("chat").on("child_added", s=>{
  const m=s.val();
  const d=document.createElement("div");
  d.className="chat-bubble"+(m.n===nickname?" me":"");
  d.textContent=m.n+" : "+m.t;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
});

/* ================= File Upload ================= */
fileInput.addEventListener("change", e=>{
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    roomRef.child("chat").push({
      n:nickname,
      img:r.result
    });
  };
  r.readAsDataURL(f);
});

roomRef.child("chat").on("child_added", s=>{
  const m=s.val();
  if(m.img){
    const img=document.createElement("img");
    img.src=m.img;
    img.className="rounded-xl max-w-[200px]";
    chat.appendChild(img);
  }
});

/* ================= iOS / ìš°í´ë¦­ ì°¨ë‹¨ ================= */
document.addEventListener("contextmenu",e=>{
  e.preventDefault(); alert("âŒ ìš°í´ë¦­ ê¸ˆì§€");
});
document.addEventListener("touchstart",e=>{
  if(e.touches.length>1) e.preventDefault();
},{passive:false});
</script>

</body>
</html>
