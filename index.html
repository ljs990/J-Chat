<!doctype html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>WebChat-Pro v.4.9.0</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#007AFF">
<link rel="manifest" id="pwa-manifest">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root { --main-blue: #007AFF; --ios-bg: #F2F2F7; }
  * { font-family: 'Pretendard', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
  body { background: #000; margin: 0; padding: 0; overflow: hidden; }
  .app-container { max-width: 420px; height: 100vh; margin: 0 auto; background: var(--ios-bg); display: flex; flex-direction: column; position: relative; }
  .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-bottom: 0.5px solid rgba(0,0,0,0.1); padding-top: env(safe-area-inset-top); z-index: 50; }
  .chat-scroll { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .bubble { padding: 10px 16px; border-radius: 20px; font-size: 15px; max-width: 78%; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .bubble-me { background: var(--main-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
  .bubble-you { background: white; color: #1c1c1e; align-self: flex-start; border-bottom-left-radius: 4px; }
  .bottom-nav { height: 85px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); }
  .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 25%; color: #8E8E93; cursor: pointer; }
  .nav-btn.active { color: var(--main-blue); }
  .input-area { padding: 10px 16px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); background: white; border-top: 0.5px solid rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; }
  .ai-status { font-size: 10px; color: var(--main-blue); text-align: center; padding: 4px; background: white; font-weight: bold; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="app-container">
  <section id="page-home" class="flex flex-col h-full">
    <header class="glass-header p-6">
      <h1 class="text-3xl font-extrabold tracking-tight">WebChat-Pro</h1>
      <p class="text-blue-500 font-bold text-[10px] tracking-widest uppercase">AI Security Enabled</p>
    </header>
    <div id="room-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
  </section>

  <section id="page-chat" class="flex flex-col h-full hidden">
    <header class="glass-header px-4 py-3 flex items-center justify-between">
      <button onclick="goHome()" class="text-blue-500 font-semibold text-lg">â€¹ ëª©ë¡</button>
      <div id="chat-title" class="font-bold text-[15px]">ëŒ€í™”ë°©</div>
      <div class="w-10"></div>
    </header>
    <div id="chat-content" class="chat-scroll"></div>
    <div id="ai-loading" class="ai-status hidden">Gemini AIê°€ ë©”ì‹œì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="input-area">
      <input id="msg-input" class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 outline-none text-[15px]" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
      <button id="send-btn" onclick="handleSendMessage()" class="w-9 h-9 bg-blue-500 rounded-full text-white flex items-center justify-center shadow-lg transition-transform active:scale-90">â†‘</button>
    </div>
  </section>

  <nav id="nav-bar" class="bottom-nav">
    <div class="nav-btn active" onclick="goHome()"><span>ğŸ </span><span class="text-[10px] font-bold">í™ˆ</span></div>
    <div class="nav-btn" onclick="askJoinRoom()"><span>ğŸ”’</span><span class="text-[10px] font-bold">ë°© ìƒì„±</span></div>
    <div class="nav-btn" onclick="openAppInstall()"><span>ğŸ“²</span><span class="text-[10px] font-bold">ì•± ì„¤ì¹˜</span></div>
    <div class="nav-btn" onclick="changeNickname()"><span>ğŸ‘¤</span><span class="text-[10px] font-bold">í”„ë¡œí•„</span></div>
  </nav>
</div>

<script>
/* ================= API êµ¬ì„± ================= */
const GEMINI_API_KEY = "AIzaSyAPnG1QVEezk0TGWJZAaw0PsyiiEE28tpQ"; // ì œê³µí•´ì£¼ì‹  í‚¤ ì ìš©
const firebaseConfig = {
  apiKey: "AIzaSyD3zF8IzJiHvbH4UrkEHEUe588um-VaUJs",
  authDomain: "j-chat-97bbe.firebaseapp.com",
  databaseURL: "https://j-chat-97bbe-default-rtdb.firebaseio.com",
  projectId: "j-chat-97bbe",
  storageBucket: "j-chat-97bbe.firebasestorage.app",
  messagingSenderId: "954905590844",
  appId: "1:954905590844:web:df95eaff0b9b24d1131739"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= PWA Manifest ================= */
const manifest = {
  "name": "WebChat-Pro Official",
  "short_name": "WebChat",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#F2F2F7",
  "theme_color": "#007AFF",
  "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/5968/5968756.png", "sizes": "512x512", "type": "image/png"}]
};
document.getElementById('pwa-manifest').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})));

let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });

/* ================= Gemini AI í•„í„°ë§ ë¡œì§ ================= */
async function checkMessageSafety(text) {
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        contents: [{ parts: [{ text: `ë‹¤ìŒ ë¬¸ì¥ì— ìš•ì„¤, ë¹„í•˜, ì„±ì ì¸ í‘œí˜„, ë˜ëŠ” ê³µê²©ì ì¸ ì–¸ì–´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ 'N'ì„, ì•ˆì „í•˜ë‹¤ë©´ 'Y'ë¥¼ í•œ ê¸€ìë¡œë§Œ ë‹µí•˜ì„¸ìš”: "${text}"` }] }]
      })
    });
    const data = await response.json();
    const result = data.candidates[0].content.parts[0].text.trim().toUpperCase();
    return result.includes('Y');
  } catch (e) {
    console.error("AI í•„í„° ì˜¤ë¥˜:", e);
    return true; // ì˜¤ë¥˜ ì‹œ ì¼ë‹¨ ì „ì†¡ í—ˆìš©
  }
}

/* ================= ì±„íŒ… í•µì‹¬ ë¡œì§ ================= */
let nickname = localStorage.getItem('pro-nick') || "ìµëª…";
let currentRoom = null;

async function handleSendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if(!text || !currentRoom) return;

  // AI ê²€ì‚¬ ì‹œì‘
  document.getElementById('ai-loading').classList.remove('hidden');
  const isSafe = await checkMessageSafety(text);
  document.getElementById('ai-loading').classList.add('hidden');

  if(!isSafe) {
    alert("âš ï¸ ì£¼ì˜: ë¶€ì ì ˆí•œ í‘œí˜„ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê±´ì „í•œ ì±„íŒ… ë¬¸í™”ë¥¼ ìœ„í•´ ë©”ì‹œì§€ë¥¼ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.");
    return;
  }

  db.ref("messages/" + currentRoom).push({
    nick: nickname,
    text: text,
    ts: Date.now(),
    uid: localStorage.getItem('pro-uid') || 'u_guest'
  });
  input.value = "";
}

function enterRoom(id) {
  currentRoom = id;
  document.getElementById('page-home').classList.add('hidden');
  document.getElementById('page-chat').classList.remove('hidden');
  document.getElementById('nav-bar').classList.add('hidden');
  document.getElementById('chat-title').textContent = id;

  const ref = db.ref("messages/" + id);
  ref.off();
  ref.limitToLast(100).on("value", s => {
    const content = document.getElementById('chat-content');
    content.innerHTML = "";
    s.forEach(c => {
      const m = c.val();
      const isMe = m.nick === nickname;
      const d = document.createElement('div');
      d.className = `bubble ${isMe ? 'bubble-me' : 'bubble-you'}`;
      d.innerHTML = `${!isMe ? `<span class="text-[10px] block opacity-60 mb-1">${m.nick}</span>` : ''}${m.text}`;
      content.appendChild(d);
    });
    content.scrollTop = content.scrollHeight;
  });
}

function goHome() {
  document.getElementById('page-home').classList.remove('hidden');
  document.getElementById('page-chat').classList.add('hidden');
  document.getElementById('nav-bar').classList.remove('hidden');
  renderRooms();
}

function askJoinRoom() {
  const name = prompt("ìƒì„±í•˜ê±°ë‚˜ ì…ì¥í•  ë°© ì½”ë“œ (#ë°©ì´ë¦„)");
  if(!name) return;
  const rooms = JSON.parse(localStorage.getItem('my-rooms') || "[]");
  if(!rooms.includes(name)) rooms.push(name);
  localStorage.setItem('my-rooms', JSON.stringify(rooms));
  enterRoom(name);
}

function renderRooms() {
  const container = document.getElementById('room-list');
  const rooms = JSON.parse(localStorage.getItem('my-rooms') || "[]");
  container.innerHTML = rooms.length ? "" : "<p class='text-center mt-20 text-gray-400 text-sm font-medium'>ì°¸ì—¬ ì¤‘ì¸ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  rooms.forEach(r => {
    const div = document.createElement('div');
    div.className = "p-5 bg-white rounded-2xl shadow-sm flex items-center justify-between active:scale-[0.98] transition-transform cursor-pointer";
    div.onclick = () => enterRoom(r);
    div.innerHTML = `<div class="flex items-center gap-4"><div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">${r[1] || 'R'}</div><span class="font-bold">${r}</span></div><span class="text-gray-300">â€º</span>`;
    container.appendChild(div);
  });
}

function openAppInstall() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt = null;
  } else {
    alert("ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆê±°ë‚˜, ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ëˆŒëŸ¬ ì„¤ì¹˜í•´ ì£¼ì„¸ìš”.");
  }
}

function changeNickname() {
  const n = prompt("ë³€ê²½í•  ë‹‰ë„¤ì„", nickname);
  if(n) { nickname = n; localStorage.setItem('pro-nick', n); renderRooms(); }
}

/* ì´ˆê¸° ì‹¤í–‰ */
renderRooms();
document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key === 'Enter') handleSendMessage(); });
</script>
</body>
</html>
